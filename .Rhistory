df$NgayNhapVien <- as.Date(df$NgayNhapVien)
df$NgayBaoCao <- as.Date(df$NgayBaoCao)
df <- df %>% filter(NgayNhapVien>=as.Date("2025-08-01"))
df_clean <- process_data_fast(df, gap = 30, output_dir = "output")
merged <- readRDS("output/merged_data.rds")
dups   <- readRDS("output/duplicates_cases.rds")
diff_sdt <- readRDS("output/diff_sdt_cases.rds")
diff_ward <- readRDS("output/diff_ward_cases.rds")
df_hcm <-  merged %>%
filter(NoiOHienTai_SauKhiSapNhap_CityId == "Thành Phố Hồ Chí Minh")
df_hcm <- mutate(df_hcm, week=isoweek(NgayNhapVien))
ward_id <- read_excel("data/ward-id.xlsx", sheet = "ward_id")
df_hcm <- mutate(df_hcm, week=isoweek(NgayNhapVien))
ward_id <- read_excel("data/ward-id.xlsx", sheet = "ward_id")
df_hcm <- df_hcm %>%
left_join(ward_id, by = "NoiOHienTai_SauKhiSapNhap_WardId")
writexl::write_xlsx(df_hcm, "data/tuan 03.xlsx")
saveRDS(df_hcm,"data/tuan03.rds")
df_hcm %>%
filter(ChanDoanChinhName == "Sốt xuất huyết Dengue") %>%
mutate(week = isoweek(NgayNhapVien)) %>%
group_by(week) %>%
summarise(n = n()) %>% (View)
df <- read_xlsx("data/1.8 - 21.1 tuan 03.xlsx")
df <- df %>% select(HoTen,NgaySinh,GioiTinh, SDT, CMND, NoiOHienNay,
NoiOHienTai_SauKhiSapNhap_WardId,
NoiOHienTai_SauKhiSapNhap_CityId, NgheNghiep, NgayNhapVien,
ChanDoanChinhName, LayMauXNName, NgayLayMau, HinhThucDieuTriName,
DonViBaoCaoName, NgayBaoCao, PhanLoaiChanDoanName,
PhanDoBenhName, ChanDoanBenhKemTheo, NgayKhoiPhat)
df <- df %>%
mutate(NgayNhapVien=dmy_hm(NgayNhapVien),
NgayBaoCao=dmy_hm(NgayBaoCao))
df$NgayNhapVien <- as.Date(df$NgayNhapVien)
df$NgayBaoCao <- as.Date(df$NgayBaoCao)
df <- df %>% filter(NgayNhapVien>=as.Date("2025-08-01"))
df_clean <- process_data_fast(df, gap = 30, output_dir = "output")
merged <- readRDS("output/merged_data.rds")
dups   <- readRDS("output/duplicates_cases.rds")
diff_sdt <- readRDS("output/diff_sdt_cases.rds")
diff_ward <- readRDS("output/diff_ward_cases.rds")
df_hcm <-  merged %>%
filter(NoiOHienTai_SauKhiSapNhap_CityId == "Thành Phố Hồ Chí Minh")
df_hcm <- mutate(df_hcm, week=isoweek(NgayNhapVien))
ward_id <- read_excel("data/ward-id.xlsx", sheet = "ward_id")
df_hcm <- df_hcm %>%
left_join(ward_id, by = "NoiOHienTai_SauKhiSapNhap_WardId")
df_hcm %>%
filter(ChanDoanChinhName == "Sốt xuất huyết Dengue") %>%
mutate(week = isoweek(NgayNhapVien)) %>%
group_by(week) %>%
summarise(n = n()) %>% (View)
df <- read_xlsx("data/1.8 - 21.1 tuan 03.xlsx")
df <- read_xlsx("data/1.8-21.1 tuan 03.xlsx")
df <- df %>% select(HoTen,NgaySinh,GioiTinh, SDT, CMND, NoiOHienNay,
NoiOHienTai_SauKhiSapNhap_WardId,
NoiOHienTai_SauKhiSapNhap_CityId, NgheNghiep, NgayNhapVien,
ChanDoanChinhName, LayMauXNName, NgayLayMau, HinhThucDieuTriName,
DonViBaoCaoName, NgayBaoCao, PhanLoaiChanDoanName,
PhanDoBenhName, ChanDoanBenhKemTheo, NgayKhoiPhat)
df <- df %>%
mutate(NgayNhapVien=dmy_hm(NgayNhapVien),
NgayBaoCao=dmy_hm(NgayBaoCao))
df$NgayNhapVien <- as.Date(df$NgayNhapVien)
df$NgayBaoCao <- as.Date(df$NgayBaoCao)
df <- df %>% filter(NgayNhapVien>=as.Date("2025-08-01"))
df_clean <- process_data_fast(df, gap = 30, output_dir = "output")
merged <- readRDS("output/merged_data.rds")
dups   <- readRDS("output/duplicates_cases.rds")
diff_sdt <- readRDS("output/diff_sdt_cases.rds")
diff_ward <- readRDS("output/diff_ward_cases.rds")
df_hcm <-  merged %>%
filter(NoiOHienTai_SauKhiSapNhap_CityId == "Thành Phố Hồ Chí Minh")
df_hcm <- mutate(df_hcm, week=isoweek(NgayNhapVien))
ward_id <- read_excel("data/ward-id.xlsx", sheet = "ward_id")
df_hcm <- df_hcm %>%
left_join(ward_id, by = "NoiOHienTai_SauKhiSapNhap_WardId")
df_hcm %>%
filter(ChanDoanChinhName == "Sốt xuất huyết Dengue") %>%
mutate(week = isoweek(NgayNhapVien)) %>%
group_by(week) %>%
summarise(n = n()) %>% (View)
df_hcm %>%
filter(ChanDoanChinhName == "Tay - chân - miệng") %>%
mutate(week = isoweek(NgayNhapVien)) %>%
group_by(week) %>%
summarise(n = n()) %>% (View)
df_hcm%>% filter(ChanDoanChinhName=="Sốt xuất huyết Dengue"& area=="KV1") %>% group_by(week) %>% summarise(n=n())
df_hcm%>% filter(ChanDoanChinhName=="Tay - chân - miệng"& area=="KV1") %>% group_by(week) %>% summarise(n=n())
df_px <- df %>%
filter(ChanDoanChinhName == "Sốt xuất huyết Dengue") %>%
group_by(week, NoiOHienTai_SauKhiSapNhap_WardId) %>%
summarise(n = n()) %>%
pivot_wider(
names_from  = week,
values_from = n,
values_fill = 0)
df_px <- df_hcm %>%
filter(ChanDoanChinhName == "Sốt xuất huyết Dengue") %>%
group_by(week, NoiOHienTai_SauKhiSapNhap_WardId) %>%
summarise(n = n()) %>%
pivot_wider(
names_from  = week,
values_from = n,
values_fill = 0)
library(tidyverse)
library(readxl)
library(janitor)
library(skimr)
library(dplyr)
library(tidyr)
library(lubridate)
library(stringr)
library(digest) #mã hóa dữ liệu
library(purrr) #xử lý nhanh hơn
#Tạo ID
create_id <- function(data) {
data %>% mutate(
name = str_to_upper(str_squish(HoTen)),
birth = as.character(NgaySinh),
sex= str_to_lower(GioiTinh),
key= paste0(name, birth, sex, NoiOHienTai_SauKhiSapNhap_WardId, sep="_"), #tạo key để đưa mã hóa
hash= sapply(key,digest,algo="md5"), #tạo mã hóa tự động cho ID
ID = hash) %>%
# ID= paste0("G",substr(hash,1,5))) %>%  #định dạng ID
select (-key, -hash, -name, -birth, -sex)
}
#Security data CHATGPT
baomat <- function(data) {
data %>%
mutate(
HoTen = str_to_title(HoTen) %>%
str_split("\\s+") %>%
lapply(function(x) {
if (length(x) == 1) {
return(x)
} else {
initials <- paste0(substr(x[-length(x)], 1, 1), ".", collapse = " ")
return(paste(c(initials, x[length(x)]), collapse = " "))
}
}) %>%
unlist(),
SDT = str_replace(SDT, ".*(\\d{4})$", "****\\1")
)
}
## Process data
process_data_fast <- function(data, gap = 30, save_rds = TRUE, output_dir = ".") {
library(dplyr)
# ===============================
# BƯỚC 1. Sắp xếp dữ liệu ban đầu
# ===============================
data <- data %>%
arrange(
HoTen, NgaySinh, GioiTinh,
NoiOHienTai_SauKhiSapNhap_WardId,
ChanDoanChinhName, NgayNhapVien, SDT
)
# ===========================================
# BƯỚC 2. Gộp trùng theo các tiêu chí chính:
# - Giống HoTen, NgaySinh, GioiTinh, ChanDoanChinhName, SDT
# - Khác WardId vẫn được gộp
# - Các lần nhập viện cách nhau <= gap ngày
# ===========================================
data <- data %>%
group_by(
HoTen, NgaySinh, GioiTinh,
ChanDoanChinhName, SDT
) %>%
mutate(
merge_group = cumsum(c(1, diff(NgayNhapVien) > gap))
) %>%
ungroup()
# =================================================
# BƯỚC 3. Lấy các nhóm có từ 2 ca trở lên (để kiểm tra)
# =================================================
duplicates <- data %>%
group_by(
HoTen, NgaySinh, GioiTinh,
ChanDoanChinhName, SDT, merge_group
) %>%
filter(n() > 1) %>%
arrange(NgayNhapVien) %>%
ungroup()
# ==================================================
# BƯỚC 4. Tạo dữ liệu để lấy ngày nhỏ nhất và lớn nhất
# ==================================================
earliest <- data %>%
group_by(
HoTen, NgaySinh, GioiTinh,
ChanDoanChinhName, SDT, merge_group
) %>%
slice_min(NgayNhapVien, with_ties = FALSE) %>%
select(
HoTen, NgaySinh, GioiTinh,
ChanDoanChinhName, SDT, merge_group,
NgayKhoiPhat, NgayNhapVien, NgayBaoCao
) %>%
ungroup()
latest <- data %>%
group_by(
HoTen, NgaySinh, GioiTinh,
ChanDoanChinhName, SDT, merge_group
) %>%
slice_max(NgayNhapVien, with_ties = FALSE) %>%
ungroup()
# =====================================================
# BƯỚC 5. Gộp dữ liệu: thông tin theo ca mới nhất,
#         ngày theo ca nhập viện sớm nhất
# =====================================================
merged_data <- latest %>%
select(-c(NgayKhoiPhat, NgayNhapVien, NgayBaoCao)) %>%
left_join(
earliest,
by = c(
"HoTen", "NgaySinh", "GioiTinh",
"ChanDoanChinhName", "SDT", "merge_group"
)
)
# ==========================================================
# BƯỚC 6. Xác định các ca nghi ngờ:
#         - diff_sdt_cases: chỉ khác SDT
#         - diff_ward_cases: chỉ khác WardId
# ==========================================================
# Nhóm theo các tiêu chí cơ bản (bỏ SDT & WardId)
base_groups <- data %>%
group_by(HoTen, NgaySinh, GioiTinh, ChanDoanChinhName) %>%
mutate(
sdt_unique = n_distinct(SDT, na.rm = TRUE),
ward_unique = n_distinct(NoiOHienTai_SauKhiSapNhap_WardId, na.rm = TRUE)
) %>%
ungroup()
diff_sdt_cases <- base_groups %>%
filter(sdt_unique > 1) %>%
arrange(HoTen, NgaySinh, GioiTinh, ChanDoanChinhName, NgayNhapVien)
diff_ward_cases <- base_groups %>%
filter(ward_unique > 1) %>%
arrange(HoTen, NgaySinh, GioiTinh, ChanDoanChinhName, NgayNhapVien)
# =====================================================
# BƯỚC 7. Lưu tất cả các file .RDS (nếu save_rds = TRUE)
# =====================================================
if (save_rds) {
dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)
saveRDS(merged_data, file = file.path(output_dir, "merged_data.rds"))
saveRDS(duplicates, file = file.path(output_dir, "duplicates_cases.rds"))
saveRDS(diff_sdt_cases, file = file.path(output_dir, "diff_sdt_cases.rds"))
saveRDS(diff_ward_cases, file = file.path(output_dir, "diff_ward_cases.rds"))
message("✅ Đã lưu 4 file RDS trong thư mục: ", normalizePath(output_dir))
}
# =====================================================
# BƯỚC 8. Trả kết quả ra dạng list để dễ truy cập trong R
# =====================================================
list(
merged_data = merged_data,
duplicates = duplicates,
diff_sdt_cases = diff_sdt_cases,
diff_ward_cases = diff_ward_cases
)
}
df <- read_xlsx("data/1.8-29.1 tuan 04.xlsx")
df <- df %>% select(HoTen,NgaySinh,GioiTinh, SDT, CMND, NoiOHienNay,
NoiOHienTai_SauKhiSapNhap_WardId,
NoiOHienTai_SauKhiSapNhap_CityId, NgheNghiep, NgayNhapVien,
ChanDoanChinhName, LayMauXNName, NgayLayMau, HinhThucDieuTriName,
DonViBaoCaoName, NgayBaoCao, PhanLoaiChanDoanName,
PhanDoBenhName, ChanDoanBenhKemTheo, NgayKhoiPhat)
df <- read_xlsx("data/1.8 - 29.1 tuan 04.xlsx")
df <- read_xlsx("data/1.8 - 29.1 tuan 04.xlsx")
df <- df %>%
mutate(NgayNhapVien=dmy_hm(NgayNhapVien),
NgayBaoCao=dmy_hm(NgayBaoCao))
df$NgayNhapVien <- as.Date(df$NgayNhapVien)
df$NgayBaoCao <- as.Date(df$NgayBaoCao)
df <- df %>% filter(NgayNhapVien>=as.Date("2025-08-01"))
df_clean <- process_data_fast(df, gap = 30, output_dir = "output")
merged <- readRDS("output/merged_data.rds")
dups   <- readRDS("output/duplicates_cases.rds")
diff_sdt <- readRDS("output/diff_sdt_cases.rds")
diff_ward <- readRDS("output/diff_ward_cases.rds")
df_hcm <-  merged %>%
filter(NoiOHienTai_SauKhiSapNhap_CityId == "Thành Phố Hồ Chí Minh")
df_hcm <- mutate(df_hcm, week=isoweek(NgayNhapVien))
ward_id <- read_excel("data/ward-id.xlsx", sheet = "ward_id")
df_hcm <- df_hcm %>%
left_join(ward_id, by = "NoiOHienTai_SauKhiSapNhap_WardId")
writexl::write_xlsx(df_hcm, "data/tuan 04.xlsx")
saveRDS(df_hcm,"data/tuan04.rds")
df_hcm %>%
filter(ChanDoanChinhName == "Sốt xuất huyết Dengue") %>%
mutate(week = isoweek(NgayNhapVien)) %>%
group_by(week) %>%
summarise(n = n()) %>% (View)
df_hcm %>%
filter(ChanDoanChinhName == "Tay - chân - miệng") %>%
mutate(week = isoweek(NgayNhapVien)) %>%
group_by(week) %>%
summarise(n = n()) %>% (View)
df_hcm %>%
filter(ChanDoanChinhName == "Sốt xuất huyết Dengue" & PhanDoBenhName== "Sốt xuất huyết Dengue nặng") %>%
mutate(week = isoweek(NgayNhapVien)) %>%
group_by(week) %>%
filter(week>=31) %>%
summarise(n = n()) %>% (View)
df_hcm%>% filter(ChanDoanChinhName=="Sốt xuất huyết Dengue"& area=="KV1") %>% group_by(week) %>% summarise(n=n())
df_hcm%>% filter(ChanDoanChinhName=="Tay - chân - miệng"& area=="KV1") %>% group_by(week) %>% summarise(n=n())
df_px <- df_hcm %>%
filter(ChanDoanChinhName == "Sốt xuất huyết Dengue") %>%
group_by(week, NoiOHienTai_SauKhiSapNhap_WardId) %>%
summarise(n = n(),.groups = "drop") %>%
pivot_wider(
names_from  = week,
values_from = n,
values_fill = 0)
View(df_px)
df_hcm %>%
filter(ChanDoanChinhName == "Sốt xuất huyết Dengue") %>%
mutate(week = isoweek(NgayNhapVien)) %>%
group_by(week) %>%
summarise(n = n()) %>% (View)
df_hcm %>%
filter(ChanDoanChinhName == "Tay - chân - miệng") %>%
mutate(week = isoweek(NgayNhapVien)) %>%
group_by(week) %>%
summarise(n = n()) %>% (View)
library(tidyverse)
library(readxl)
library(janitor)
library(skimr)
library(dplyr)
library(tidyr)
library(lubridate)
library(stringr)
library(digest) #mã hóa dữ liệu
library(purrr) #xử lý nhanh hơn
#Tạo ID
create_id <- function(data) {
data %>% mutate(
name = str_to_upper(str_squish(HoTen)),
birth = as.character(NgaySinh),
sex= str_to_lower(GioiTinh),
key= paste0(name, birth, sex, NoiOHienTai_SauKhiSapNhap_WardId, sep="_"), #tạo key để đưa mã hóa
hash= sapply(key,digest,algo="md5"), #tạo mã hóa tự động cho ID
ID = hash) %>%
# ID= paste0("G",substr(hash,1,5))) %>%  #định dạng ID
select (-key, -hash, -name, -birth, -sex)
}
#Security data CHATGPT
baomat <- function(data) {
data %>%
mutate(
HoTen = str_to_title(HoTen) %>%
str_split("\\s+") %>%
lapply(function(x) {
if (length(x) == 1) {
return(x)
} else {
initials <- paste0(substr(x[-length(x)], 1, 1), ".", collapse = " ")
return(paste(c(initials, x[length(x)]), collapse = " "))
}
}) %>%
unlist(),
SDT = str_replace(SDT, ".*(\\d{4})$", "****\\1")
)
}
## Process data
process_data_fast <- function(data, gap = 30, save_rds = TRUE, output_dir = ".") {
library(dplyr)
# ===============================
# BƯỚC 1. Sắp xếp dữ liệu ban đầu
# ===============================
data <- data %>%
arrange(
HoTen, NgaySinh, GioiTinh,
NoiOHienTai_SauKhiSapNhap_WardId,
ChanDoanChinhName, NgayNhapVien, SDT
)
# ===========================================
# BƯỚC 2. Gộp trùng theo các tiêu chí chính:
# - Giống HoTen, NgaySinh, GioiTinh, ChanDoanChinhName, SDT
# - Khác WardId vẫn được gộp
# - Các lần nhập viện cách nhau <= gap ngày
# ===========================================
data <- data %>%
group_by(
HoTen, NgaySinh, GioiTinh,
ChanDoanChinhName, SDT
) %>%
mutate(
merge_group = cumsum(c(1, diff(NgayNhapVien) > gap))
) %>%
ungroup()
# =================================================
# BƯỚC 3. Lấy các nhóm có từ 2 ca trở lên (để kiểm tra)
# =================================================
duplicates <- data %>%
group_by(
HoTen, NgaySinh, GioiTinh,
ChanDoanChinhName, SDT, merge_group
) %>%
filter(n() > 1) %>%
arrange(NgayNhapVien) %>%
ungroup()
# ==================================================
# BƯỚC 4. Tạo dữ liệu để lấy ngày nhỏ nhất và lớn nhất
# ==================================================
earliest <- data %>%
group_by(
HoTen, NgaySinh, GioiTinh,
ChanDoanChinhName, SDT, merge_group
) %>%
slice_min(NgayNhapVien, with_ties = FALSE) %>%
select(
HoTen, NgaySinh, GioiTinh,
ChanDoanChinhName, SDT, merge_group,
NgayKhoiPhat, NgayNhapVien, NgayBaoCao
) %>%
ungroup()
latest <- data %>%
group_by(
HoTen, NgaySinh, GioiTinh,
ChanDoanChinhName, SDT, merge_group
) %>%
slice_max(NgayNhapVien, with_ties = FALSE) %>%
ungroup()
# =====================================================
# BƯỚC 5. Gộp dữ liệu: thông tin theo ca mới nhất,
#         ngày theo ca nhập viện sớm nhất
# =====================================================
merged_data <- latest %>%
select(-c(NgayKhoiPhat, NgayNhapVien, NgayBaoCao)) %>%
left_join(
earliest,
by = c(
"HoTen", "NgaySinh", "GioiTinh",
"ChanDoanChinhName", "SDT", "merge_group"
)
)
# ==========================================================
# BƯỚC 6. Xác định các ca nghi ngờ:
#         - diff_sdt_cases: chỉ khác SDT
#         - diff_ward_cases: chỉ khác WardId
# ==========================================================
# Nhóm theo các tiêu chí cơ bản (bỏ SDT & WardId)
base_groups <- data %>%
group_by(HoTen, NgaySinh, GioiTinh, ChanDoanChinhName) %>%
mutate(
sdt_unique = n_distinct(SDT, na.rm = TRUE),
ward_unique = n_distinct(NoiOHienTai_SauKhiSapNhap_WardId, na.rm = TRUE)
) %>%
ungroup()
diff_sdt_cases <- base_groups %>%
filter(sdt_unique > 1) %>%
arrange(HoTen, NgaySinh, GioiTinh, ChanDoanChinhName, NgayNhapVien)
diff_ward_cases <- base_groups %>%
filter(ward_unique > 1) %>%
arrange(HoTen, NgaySinh, GioiTinh, ChanDoanChinhName, NgayNhapVien)
# =====================================================
# BƯỚC 7. Lưu tất cả các file .RDS (nếu save_rds = TRUE)
# =====================================================
if (save_rds) {
dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)
saveRDS(merged_data, file = file.path(output_dir, "merged_data.rds"))
saveRDS(duplicates, file = file.path(output_dir, "duplicates_cases.rds"))
saveRDS(diff_sdt_cases, file = file.path(output_dir, "diff_sdt_cases.rds"))
saveRDS(diff_ward_cases, file = file.path(output_dir, "diff_ward_cases.rds"))
message("✅ Đã lưu 4 file RDS trong thư mục: ", normalizePath(output_dir))
}
# =====================================================
# BƯỚC 8. Trả kết quả ra dạng list để dễ truy cập trong R
# =====================================================
list(
merged_data = merged_data,
duplicates = duplicates,
diff_sdt_cases = diff_sdt_cases,
diff_ward_cases = diff_ward_cases
)
}
df <- read_xlsx("data/1.8 - 29.1 tuan 04.xlsx")
df <- df %>% select(HoTen,NgaySinh,GioiTinh, SDT, CMND, NoiOHienNay,
NoiOHienTai_SauKhiSapNhap_WardId,
NoiOHienTai_SauKhiSapNhap_CityId, NgheNghiep, NgayNhapVien,
ChanDoanChinhName, LayMauXNName, NgayLayMau, HinhThucDieuTriName,
DonViBaoCaoName, NgayBaoCao, PhanLoaiChanDoanName,
PhanDoBenhName, ChanDoanBenhKemTheo, NgayKhoiPhat)
df <- df %>%
mutate(NgayNhapVien=dmy_hm(NgayNhapVien),
NgayBaoCao=dmy_hm(NgayBaoCao))
df$NgayNhapVien <- as.Date(df$NgayNhapVien)
df$NgayBaoCao <- as.Date(df$NgayBaoCao)
df <- df %>% filter(NgayNhapVien>=as.Date("2025-08-01"))
df_clean <- process_data_fast(df, gap = 30, output_dir = "output")
df_hcm %>%
filter(ChanDoanChinhName == "Tay - chân - miệng") %>%
mutate(week = isoweek(NgayNhapVien)) %>%
group_by(week) %>%
summarise(n = n()) %>% (View)
df_hcm %>%
filter(ChanDoanChinhName == "Sốt xuất huyết Dengue" & PhanDoBenhName== "Sốt xuất huyết Dengue nặng") %>%
mutate(week = isoweek(NgayNhapVien)) %>%
group_by(week) %>%
filter(week>=31) %>%
summarise(n = n()) %>% (View)
df_hcm %>%
filter(ChanDoanChinhName == "Sốt xuất huyết Dengue" & PhanDoBenhName== "Sốt xuất huyết Dengue nặng") %>%
mutate(week = isoweek(NgayNhapVien)) %>%
group_by(week) %>%
summarise(n = n()) %>% (View)
View(df_hcm)
df_hcm %>%
filter(ChanDoanChinhName == "Sốt xuất huyết Dengue" & PhanDoBenhName== "Sốt xuất huyết Dengue có dấu hiệu cảnh báo") %>%
mutate(week = isoweek(NgayNhapVien)) %>%
group_by(week) %>%
summarise(n = n()) %>% (View)
